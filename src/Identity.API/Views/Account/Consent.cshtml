@page "/Views/Account/Consent"
@model Identity.API.Views.Account.ConsentModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authorize Application - Identity Server</title>
    <link rel="stylesheet" href="~/Views/Shared/styles.css" />
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="logo">
                <h1>Identity Server</h1>
                <p>Application Authorization</p>
            </div>

            <form method="post" data-validate="true">
                @Html.AntiForgeryToken()
                <div id="main-content">
                    <!-- Error Message -->
                    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                    {
                        <div class="error-message" role="alert">
                            @Model.ErrorMessage
                        </div>
                    }

                    <!-- Validation Summary -->
                    <div asp-validation-summary="ModelOnly" class="error-message" role="alert"></div>

                    <!-- Consent Information -->
                    @if (Model.ConsentData != null)
                    {
                        <div class="consent-info">
                            <h2>Authorize @Model.ConsentData.ApplicationName</h2>
                            <p>
                                <strong>@Model.ConsentData.ApplicationName</strong> is requesting access to your account.
                                This application is asking for the following permissions:
                            </p>
                        </div>

                        <!-- Requested Scopes -->
                        <div class="scopes-list">
                            @foreach (var scope in Model.ConsentData.ScopeDescriptions)
                            {
                                <div class="scope-item">
                                    <div class="scope-icon"></div>
                                    <div class="scope-details">
                                        <h4>@scope.DisplayName</h4>
                                        <p>@scope.Description</p>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Remember Consent -->
                        <div class="checkbox-group">
                            <input asp-for="Input.RememberConsent" type="checkbox" />
                            <label asp-for="Input.RememberConsent">Don't ask again for this application</label>
                        </div>

                        <!-- Hidden Fields -->
                        <input type="hidden" asp-for="ReturnUrl" value="@Model.ReturnUrl" />

                        <!-- Action Buttons -->
                        <div class="button-group">
                            <button type="submit" name="Input.Action" value="allow" class="btn btn-primary">
                                Allow Access
                            </button>
                            <button type="submit" name="Input.Action" value="deny" class="btn btn-secondary">
                                Deny Access
                            </button>
                        </div>

                        <!-- Application Information -->
                        <div class="links">
                            <small>
                                By clicking "Allow Access", you authorize @Model.ConsentData.ApplicationName to access your data as described above.
                                You can revoke this authorization at any time in your account settings.
                            </small>
                        </div>
                    }
                    else
                    {
                        <div class="error-message" role="alert">
                            Unable to load consent information. Please try again.
                        </div>
                        <div class="links">
                            <a href="@Model.ReturnUrl" class="btn btn-secondary">Go Back</a>
                        </div>
                    }
                </div>
            </form>
        </div>
    </div>

    <!-- Client-side Scripts -->
    <script src="~/Views/Shared/scripts.js"></script>
    <script type="text/javascript">
        // Page-specific JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Confirm deny action
            const denyButton = document.querySelector('button[value="deny"]');
            if (denyButton) {
                denyButton.addEventListener('click', function(e) {
                    if (!confirm('Are you sure you want to deny access to this application?')) {
                        e.preventDefault();
                        return false;
                    }
                });
            }

            // Show loading state on form submission
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const submitBtn = e.submitter;
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        
                        if (submitBtn.value === 'allow') {
                            submitBtn.textContent = 'Authorizing...';
                        } else {
                            submitBtn.textContent = 'Denying...';
                        }
                        
                        submitBtn.classList.add('loading');
                    }
                });
            }

            // Auto-focus first action button
            const allowButton = document.querySelector('button[value="allow"]');
            if (allowButton) {
                allowButton.focus();
            }
        });
    </script>

    @section Scripts {
        @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    }
</body>
</html>